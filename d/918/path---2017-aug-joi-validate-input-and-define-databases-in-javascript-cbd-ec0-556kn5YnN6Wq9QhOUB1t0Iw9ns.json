{"data":{"site":{"siteMetadata":{"title":"Bruno Luiz Blog","author":"Bruno Luiz Silva"}},"markdownRemark":{"id":"6c574928-0460-5330-b51f-838430906434","excerpt":"As the saying goes:  never trust user input . People coming from PHP and Java have many validation libraries available. But what about JavaScript? There areâ€¦","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b7a8c8cd751a67c7db21ec8d7de792c/56447/header.jpeg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABQAE/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABNXy6hGHj/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIAAwQSExQj/9oACAEBAAEFAhMXWtFtRgOOuD2XqtP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAADAQADAAAAAAAAAAAAAAAAAQIhESJB/9oACAEBAAY/AiqrEcqkdkPxGWj/xAAaEAADAQEBAQAAAAAAAAAAAAAAAREhMUFx/9oACAEBAAE/IYujPfTrMuhR0ZKz+RHwH//aAAwDAQACAAMAAAAQs8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAdEAEBAAIBBQAAAAAAAAAAAAABEQAhMUFRgaGx/9oACAEBAAE/ECo0uCEQkLTcwRYd2J4wiU5wlfesJfXgbR6Nz6oEz//Z'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Photo by Rayi Christian Wicaksono\"\n        title=\"\"\n        src=\"/static/3b7a8c8cd751a67c7db21ec8d7de792c/cfe7c/header.jpeg\"\n        srcset=\"/static/3b7a8c8cd751a67c7db21ec8d7de792c/f39eb/header.jpeg 180w,\n/static/3b7a8c8cd751a67c7db21ec8d7de792c/e1b9c/header.jpeg 360w,\n/static/3b7a8c8cd751a67c7db21ec8d7de792c/cfe7c/header.jpeg 720w,\n/static/3b7a8c8cd751a67c7db21ec8d7de792c/deb56/header.jpeg 1080w,\n/static/3b7a8c8cd751a67c7db21ec8d7de792c/cf22f/header.jpeg 1440w,\n/static/3b7a8c8cd751a67c7db21ec8d7de792c/56447/header.jpeg 1600w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>As the saying goes: <em>never trust user input</em>. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.</p>\n<p><a href=\"https://github.com/hapijs/joi\">Joi</a> is maintained by <a href=\"https://hapijs.com/\">Hapi.js project</a>. Even though hapi.js is a web framework by itself, Joi is independent and can be used in any type of node project. This is great for people using express or restify, for example.</p>\n<p>What makes it even more interesting is that, besides user validation, it can be used to define database schemas as well. This post will introduce a quick start guide, with some usage cases and general tweaks.</p>\n<h2>How to use it?</h2>\n<p>First things first: it has to be installed on the project. Considering an already initiated node project, the command to install it is: npm install joi. After being installed, a schema is required to use it, such as the file <code>rating-schema.js</code> below:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// rating-schema.js</span>\n<span class=\"token keyword\">const</span> Joi <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joi'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  username<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  rating<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">number</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">integer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  email<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">email</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">required</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This defines a model where an username, a rating (from 1 to 5) and an email (which is a required field) are expected. This is a simple example, but there are way more validation options, which can be found on the <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md\">API reference</a>. To use the defined schema, consider a file called <code>rating-test.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// rating-test.js</span>\n\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./rating-schema'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n  username<span class=\"token punctuation\">:</span> <span class=\"token string\">'brunoluiz'</span><span class=\"token punctuation\">,</span>\n  rating<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n  email<span class=\"token punctuation\">:</span> <span class=\"token string\">'contact@brunoluiz.net'</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token comment\">// result.error will be null</span>\n\n<span class=\"token comment\">// result.error will show an error due to missing e-mail</span>\n<span class=\"token keyword\">const</span> resultWithError <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n  username<span class=\"token punctuation\">:</span> <span class=\"token string\">'brunoluiz'</span><span class=\"token punctuation\">,</span>\n  rating<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>resultWithError<span class=\"token punctuation\">)</span><span class=\"token comment\">// result.error will have an error message</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md#errors\">More about Joi errors</a></p>\n<h2>Real project usage</h2>\n<h3>Validation middleware</h3>\n<p>In a real project, Joi can be used on a middleware layer. On <a href=\"http://expressjs.com\"><code>express</code></a>, for example, this can be done using:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// ratings-validor.js</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ratings <span class=\"token operator\">=</span> Ratings<span class=\"token punctuation\">.</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ratings<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>ratings<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  req<span class=\"token punctuation\">.</span>parsed <span class=\"token operator\">=</span> ratings<span class=\"token punctuation\">.</span>value\n  <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// ....</span>\n<span class=\"token comment\">// routes.js</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/ratings'</span><span class=\"token punctuation\">,</span>\n  ratingsValidator<span class=\"token punctuation\">,</span>\n  ratingsCreateController\n<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this case, if the <code>ratingsValidator</code> returns an error due to validation, express will stop the request before even reaching the controller.</p>\n<h3>Database schema (MongoDB and DynamoDB)</h3>\n<p>Some tools can use it to define their database schema (keep in mind that Joi is not an ORM). For MongoDB, <code>mongoose</code> can be used together with <a href=\"https://github.com/yoitsro/joigoose\"><code>joigoose</code></a>, which easily converts a Joi schema. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// rating.js</span>\n<span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> joigoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joigoose'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>mongoose<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Require the 'ratings' schema</span>\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./rating-schema'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Convert joi to mongoose schema</span>\n<span class=\"token keyword\">const</span> mongooseSchema <span class=\"token operator\">=</span> joigoose<span class=\"token punctuation\">.</span><span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Modify some fields with database specific instructions </span>\nmongooseSchema<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span>unique <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token comment\">// Add fields which don't make sense on the schema validator</span>\nmongooseSchema<span class=\"token punctuation\">.</span>updatedAt <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">.</span>now <span class=\"token punctuation\">}</span>\nmongooseSchema<span class=\"token punctuation\">.</span>createdAt <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">.</span>now <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Define mongoose model</span>\n<span class=\"token keyword\">const</span> Ratings <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ratings'</span><span class=\"token punctuation\">,</span> mongooseSchema<span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Ratings</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Through <a href=\"https://github.com/ryanfitz/vogels\"><code>vogels</code></a>, the same can be done in projects using DynamoDB. By default, it accepts Joi as its schema definition. The following example is based on <code>vogels</code> documentation:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// blog-post-schema.js</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">email</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  title<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  content<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">binary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  tags<span class=\"token punctuation\">:</span> vogels<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">stringSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// blog-post.js</span>\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./blog-post-schema.js'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> vogels<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'BlogPost'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  hashKey<span class=\"token punctuation\">:</span> <span class=\"token string\">'email'</span><span class=\"token punctuation\">,</span>\n  rangeKey<span class=\"token punctuation\">:</span> â€˜titleâ€™<span class=\"token punctuation\">,</span>\n  schema\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>Exchangeability for front-end validation</h3>\n<p>Some developers prefer to define the schema once and then use everywhere, including on browsers. Today <a href=\"https://github.com/hapijs/joi/#browsers\">Joi doesnâ€™t support browser usage</a>, but a package called <a href=\"https://github.com/jeffbski/joi-browser\"><code>joi-browser</code> does this job</a>, enabling the usage of exactly the same schema on the front-end as well.</p>\n<h2>Useful tweaks</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7711ddf8c0852584701f24f93b2988d7/c7ad5/tweaking.jpeg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIFBP/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHKyUYkjCf/xAAaEAADAQADAAAAAAAAAAAAAAABAgMAERIi/9oACAEBAAEFAlnyDAYx03Kv280oQ3//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8BR//EABkQAAIDAQAAAAAAAAAAAAAAAAAxEBIhYf/aAAgBAQAGPwKGVfRGH//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExYaH/2gAIAQEAAT8h9yJ6Uyhz4jF8Q6KMiUpU/9oADAMBAAIAAwAAABAQ/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAAREP/aAAgBAwEBPxBJ/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Qi3//xAAcEAEAAgMAAwAAAAAAAAAAAAABABEhUWExgcH/2gAIAQEAAT8QI3EYJeGGOph7FIVDXg+9wFAslbpCUQRsv7P/2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Photo by chuttersnap on Unsplash\"\n        title=\"\"\n        src=\"/static/7711ddf8c0852584701f24f93b2988d7/cfe7c/tweaking.jpeg\"\n        srcset=\"/static/7711ddf8c0852584701f24f93b2988d7/f39eb/tweaking.jpeg 180w,\n/static/7711ddf8c0852584701f24f93b2988d7/e1b9c/tweaking.jpeg 360w,\n/static/7711ddf8c0852584701f24f93b2988d7/cfe7c/tweaking.jpeg 720w,\n/static/7711ddf8c0852584701f24f93b2988d7/deb56/tweaking.jpeg 1080w,\n/static/7711ddf8c0852584701f24f93b2988d7/cf22f/tweaking.jpeg 1440w,\n/static/7711ddf8c0852584701f24f93b2988d7/54366/tweaking.jpeg 2160w,\n/static/7711ddf8c0852584701f24f93b2988d7/c7ad5/tweaking.jpeg 4000w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>#1 Disable Joi number() convert</h3>\n<p>By default, Joi allows users to pass numbers formatted as strings, in cases of number() fields. This is specially bad if the validate() result is only used to check if there was an error, but not for itâ€™s value field. To solve this, there are two possible solutions</p>\n<ol>\n<li>\n<p>On <code>schema.validate(value)</code>, an extra parameter can be passed to disable it, as: <code>schema.validate(value, { convert: false })</code></p>\n</li>\n<li>\n<p>Put a <code>strict()</code> at the end of the desired number field, as: <code>Joi.number().strict()</code></p>\n</li>\n</ol>\n<p>Both of them are quite annoying, because either all fields or all function calls require a specific config. One way to solve this is by extending Joiâ€¦</p>\n<h3>#2 Extend Joi defaults</h3>\n<p>In cases such as the above, or for new field types, or even when the behavior of a default field has to be changed, <code>Joi.extend()</code> can be an option.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// joi.js</span>\n\n<span class=\"token keyword\">const</span> Joi <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joi'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> ukzip <span class=\"token operator\">=</span> <span class=\"token regex\">/^[A-Z]{1,2}[0-9]{1,2}[A-Z]{0,1} ?[0-9][A-Z]{2}$/i</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span>\n  base<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">number</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">strict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token string\">'zipcode'</span><span class=\"token punctuation\">,</span>\n  base<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">regex</span><span class=\"token punctuation\">(</span>ukzip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">description</span><span class=\"token punctuation\">(</span><span class=\"token string\">'UK Zipcode'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>When using Joi through this file, all number fields will be on the strict mode â€” which solves the issue of applying tweak #1 everywhere â€” and a <code>zipcode()</code> validator is created, based on a pre-defined regex.</p>\n<p>More rules can be added and, actually, the Joi API enables <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md#extendextension\">much more customisation</a> on <code>Joi.extend</code>.</p>\n<h3>#3 Create default fields</h3>\n<p>In some projects, a lot of models will have some default fields, such as an <code>extensionAttributes</code>, where custom vendor data will be put into (as Magento already does) or <code>updatedAt</code>. In these cases, the <code>Joi.object</code> can be extended to include default fields:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// joi.js</span>\n\n<span class=\"token keyword\">const</span> Joi <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joi'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">,</span>\n  base<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n    extensionAttributes<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    updatedAt<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>#4 Show all validation errors</h3>\n<p>Usually Joi validation dies on the first error, returning on itâ€™s message which field failed. This is an issue when an input have many fields with problems. The user will have to do many requests to discover all problematic fields. To fix this issue, the following option can be added on the function call:</p>\n<p><code>const result = schema.validate(value, { abortEarly: false })</code></p>\n<p>With this config, if an error occurs, the <code>result.error</code> will return all validation failures.</p>\n<h3>#5 Built-in Joi conditional validations</h3>\n<p>If a field depends on values from another field, the conditional when() can be used.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// joi-from-doc.js</span>\n\n<span class=\"token keyword\">const</span> Joi <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'joi'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  a<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">valid</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> \n      is<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> \n      then<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">valid</span><span class=\"token punctuation\">(</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n      otherwise<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">valid</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  b<span class=\"token punctuation\">:</span> Joi<span class=\"token punctuation\">.</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">:</span> <span class=\"token string\">'x'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// valid</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">:</span> <span class=\"token string\">'z'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// valid</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">:</span> <span class=\"token string\">'z'</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// valid</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">:</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// invalid</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">:</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// valid</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this case, the field <code>a</code> accepts the values <code>x, y, z</code>. But, to accept <code>y</code> as a value, the field b have to be equals 5, otherwise only <code>x</code> and <code>z</code> will be accepted.</p>\n<p>Of course, this is a simple and fictitious conditional validation, but it is quite useful in cases where some field requires a specific validator when some other had a specific input.</p>\n<h2>Are you ready to use it?</h2>\n<p>I hope this post convinced you to use some validation tool such as Joi, instead of validating everything by hand (or not validating at all). But, if you are using it already: do you know any other cool trick or tweak? Let me know in the comments section below.</p>\n<h2>References</h2>\n<ul>\n<li>\n<p>Joi repo: <a href=\"https://github.com/hapijs/joi\">https://github.com/hapijs/joi</a></p>\n</li>\n<li>\n<p>Joi API Reference: <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md\">https://github.com/hapijs/joi/blob/v10.6.0/API.md</a></p>\n</li>\n<li>\n<p>Joigoose repo: <a href=\"https://github.com/yoitsro/joigoose\">https://github.com/yoitsro/joigoose</a></p>\n</li>\n<li>\n<p>Joi-browser repo: <a href=\"https://github.com/jeffbski/joi-browser\">https://github.com/jeffbski/joi-browser</a></p>\n</li>\n<li>\n<p>Mongoose website: <a href=\"http://mongoosejs.com\">http://mongoosejs.com</a></p>\n</li>\n<li>\n<p>Vogels repo: <a href=\"https://github.com/ryanfitz/vogels\">https://github.com/ryanfitz/vogels</a></p>\n</li>\n</ul>","frontmatter":{"title":"Joi: validate input and define databases in JavaScript","date":"August 30, 2017","cover":{"childImageSharp":{"fixed":{"width":1200,"height":900,"src":"/static/3b7a8c8cd751a67c7db21ec8d7de792c/935ac/header.jpeg","srcSet":"/static/3b7a8c8cd751a67c7db21ec8d7de792c/935ac/header.jpeg 1x"}}}}}},"pageContext":{"slug":"/2017/aug/joi-validate-input-and-define-databases-in-javascript/","previous":{"fields":{"slug":"/2017/jul/still-using-gitflow-what-about-a-simpler-alternative/"},"frontmatter":{"title":"Still using GitFlow? What about a simpler alternative?"}},"next":{"fields":{"slug":"/2018/mar/a-tale-of-how-to-not-deploy-two-months-old-features/"},"frontmatter":{"title":"A Tale Of How To Not Deploy Two Months Old Features"}}}}